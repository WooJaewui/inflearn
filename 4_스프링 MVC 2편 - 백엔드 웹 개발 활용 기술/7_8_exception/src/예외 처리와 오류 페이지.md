
# 예외 처리와 오류 페이지.

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿 예외 처리 - 시작.

### 서블릿의 예외 처리 방식 2가지.
1. Exception(예외)
2. response.sendError(HTTP 상태 코드, 오류 메시지)


### 웹 어플리케이션.
- 웹 어플리케이션은 사용자 요청별로 별도의 쓰레드가 할당되고, 서블릿 컨테이너 안에서 실행된다.
- 어플리케이션에서 예외가 발생했는데, "try-catch"로 예외를 잡아서 처리하면 아무런 문제가 없다.


### 예외 흐름.
- 컨트롤러(예외 발생) -> 인터셉터(afterComplete) -> 서블릿 -> 필터 -> WAS(여기까지 전파)


### 500 에러.
- "Exception"의 경우 서버 내부에서 처리할 수 없는 오류가 발생한 것으로 생각해서 HTTP 상태 코드 500을 반환한다.


### response.sendError(HTTP 상태코드, 오류 메시지)
- 오류가 발생했을 때 "HttpServletResponse"가ㅣ 제공하는 sendError()라는 메서드를 사용해도 된다.
- 이것을 호출한다고 당장 예외가 발생하는 것은 아니지만, 서블릿 컨테이너에게 오류가 발생했다는 점을 전달할 수 있다.
- 이 메서드를 사용하면 HTTP 상태 코드와 오류 메시지도 추가할 수 있다.


### sendError 흐름.
- 컨트롤러(response.sendError()) -> 인터셉터 -> 서블릿 -> 필터 -> WAS(sendError 호출 기록 확인)
- response.sendError()를 호출하면 response 내부에는 오류가 발생했다는 상태를 저장해둔다.
- 서블릿 컨테이너는 고객에게 응답 전에 response에 sendError()가 호출되었는지 확인한다.
- 호출되었다면 설정한 오류 코드에 맞추어 기본 오류 페이지를 보여준다.


### 정리.
- 서블렛 컨테이너가 제공하는 기본 예외 처리 화면은 사용자가 보기에 불편하다. 의미 있는 오류 화면을 제공해보자.

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿 예외 처리 - 오류 화면 제공.

### 참고.
- 오류 페이지는 예외를 다룰 ㄸ때 해당 예외와 그 자식 타입의 오류를 함께 처리해준다.
- 예를 들어 "RuntimeException"으로 설정하면 "RuntimeException"의 자식도 함께 처리한다.


### 일반 스프링 방식.
    <web-app>
        <error-page>
            <error-code>404</error-code>
            <location>/error-page/404.html</location>
        </error-page>
        <error-page>
            <error-code>500</error-code>
            <location>/error-page/500.html</location>
        </error-page>
        ...
    </web-app>
- 과거에 일반 스프링을 사용할 때는 web.xml 파일에 오류 화면을 등록했다.


### 스프링 부트 사용 방식.
    @Component
    public class 클래스이름 implements WebServerFactoryCustomizer<ConfigurableWebServerFactory> {

        @Override
        public void customize(ConfigurableWebServerFactory factory) {
            ErrorPage errorPage404 = new ErrorPage(HttpStatus.NOT_FOUND, "/error/url);
            ...
        
            factory.addErrorPages(errorPage404, ... );
        }
    }

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿 예외 처리 - 오류 페이지 작동 원리.

### 예외 발생 흐름.
- 컨트롤러(예외 발생) -> 인터셉터 -> 서블릿 -> 필터 -> WAS(여기까지 전파)


### sendError 흐름.
- 컨트롤러(response.sendError()) -> 인터셉터 -> 서블릿 -> 필터 -> WAS(sendError 호출 기록 확인)


### WAS
- "WAS"는 오류 페이지 정보를 확인한다. (new ErrorPage(...))
- "WAS"는 오류 페이지를 출력하기 위해 "/url"을 다시 요청한다.


### 오류 페이지 요청 흐름.
1. 컨트롤러 -> 인터셉터 -> 서블릿 -> 필터 -> WAS(오류 페이지 정보 확인)
2. WAS(오류 페이지 정보가 있는 경우) -> /error/url 다시 요청 -> 필터 -> 서블릿 -> 인터셉터 -> 컨트롤러(/error/url) -> view.


### 중요.
- 웹 브라우저(클라이언트)는 서버 내부에서 이런 일이 일어나는지 전혀 모른다는 점이다.
- 오직 서버 내부에서 오류 페이지를 찾기 위해 추가적인 호출을 한다.


### 정리.
- 예외가 발생하면 "WAS"까지 전파된다.
- "WAS"는 오류 페이지 경로를 찾아서 내부에서 오류 페이지를 호출한다.
- 이때, 오류 페이지 경로를 필터, 서블릿, 인터셉터, 컨트롤러가 모두 다시 호출된다.


### 오류 정보 추가.
- "WAS"는 오류 페이지를 단순히 다시 요청만 하는 것이 아니라, 오류 정보를 "request attribute"에 추가해서 넘겨준다.
- 필요하면 오류 페이지에서 이렇게 전달된 오류 정보를 사용할 수 있다.


### 오류 정보 얻기.
- RequestDispatcher 클래스에 상수로 정의되어 있다.

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿 예외 처리 - 필터.

### 개요.
- 오류가 발생하면 오류 페이지를 출력하기 위해 "WAS" 내부에서 다시 한번 호출이 발생한다.
- 내부 오류 페이지를 호출한다고 해서 해당 필터나 인터셉터가 다시 한번 더 호출되는 것은 매우 비효율적이다.
- 서블릿은 이런 문제를 해결하기 위해 "DispatcherType"이라는 추가 정보를 제공한다.


### DispatcherType.
- 고객이 처음 요청하면 "dispatcherType=REQUEST"이다.
- 이렇듯 서블릿은 실제 고객이 요청한 것인지, 서버가 내부에서 오류 페이지를 요청하는 것인지 "DispatcherType"으로 구분할 수 있는 방법을 제공.


### DispatcherType enum.
- REQUEST : 클라이언트 요청.
- ERROR : 오류 요청.
- FORWARD : MVC에서 배웠던 서블릿에서 다른 서블릿이나 JSP를 호출할 때.
- INCLUDE : 서블릿에서 다른 서블릿이나 JSP의 결과를 포함할 때.
- ASYNC : 서블릿 비동기 호출.


### 필터 설정.
    filterRegistrationBean.setDispatcherTypes(DispatcherType.REQUEST, DispatcherType.ERROR);
- 아무것도 넣지 않으면 기본 값이 "DispatcherType=REQUEST"이다. (클라이언트의 요청이 있는 경우에만 필터가 적용)

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿 예외 처리 - 인터셉터.

### 인터셉터.
- 인터셉터는 excludePathPatterns()에 제외 url를 설정함으로써 error 발생 시 인터셉터가 호출되지 않도록 만든다. 


### 전체 흐름 정리. (필터, 인터셉터 두 번 호출하지 않도록 설정 후)
1. WAS(/error/ex, dispatcherType=REQUEST) -> 필터 -> 서블릿 -> 인터셉터 -> 컨트롤러.
2. 컨트롤러(예외 발생) -> 인터셉터 -> 서블릿 -> 필터 -> WAS(여기까지 전파)
3. WAS 오류 페이지 확인.
4. WAS(/error-page/500, dispatcherType=ERROR) -> 필터(X) -> 서블릿 -> 인터셉터(x) -> 컨트롤러 -> view.

------------------------------------------------------------------------------------------------------------------------------------

> ## 스프링 부트 - 오류 페이지1.

### 오류 설정 과정.
1. WebServerCustomizer 만들기.
2. 예외 종류에 따라서 "ErrorPage"를 추가.
3. 예외 처리용 컨트롤러 "ErrorPageController"를 만듦.


### 스프링 부트는 이런 괒어을 모두 기본으로 제공한다.
- "ErrorPage"를 자동으로 등록한다.
  - 이 때, "/error"라는 경로로 기본 오류 페이지를 설정한다.
  - 상태코드와 예외를 설정하지 않으면 기본 오류 페이지로 사용된다.
  - 서블릿 밖으로 예외가 발생하거나, response.sndError(...)가 호출되면 모든 오류는 "/error"를 호출하게 된다.
- "BasicErrorController"라는 스프링 컨트롤러를 자동으로 등록한다.
  - "ErrorPage"에서 등록한 "/error"를 매핑해서 처리하는 컨트롤러다.


### 참고.
- "ErrorMvcAutoConfiguration" 클래스가 오류 페이지를 자동으로 등록하는 역할을 한다.


### 뷰 선택 우선순위.
1. 뷰 템플릿.
   - resources/templates/error/500.html
   - resources/templates/error/5xx.html
2. 정적 리소스(static, public)
   - resources/static/error/400.html
   - resources/static/error/404.html
   - resources/static/error/4xx.html
3. 적용 대상이 없을 때 뷰 이름('error')
   - resources/templates/error.html


### 부트에 오류 처리.
- 해당 경로 위치에 HTTP 상태 코드 이름의 뷰 파일을 넣어두면 된다.
- 뷰 템플릿이 정적 리소스보다 우선순위가 높고, 404, 500처럼 구체적인 것이 5xx처럼 덜 구체적인 것보다 우선순위가 높다.
- 5xx, 4xx라고 하면 500대, 400대 오류를 처리해준다.

------------------------------------------------------------------------------------------------------------------------------------

> ## 스프링 부트 - 오류 페이지2.

### BasicErrorController 클래스.
- 오류 관련 정보들을 제공한다.
- 오류 관련 내부 정보들을 고객에게 노출하는 것은 좋지 않다. (보안상 문제)
- "BasicErrorController"에서 오류 정보를 model에 포함할지 여부를 선택할 수 있다.


### 스프링 부트 오류 관련 옵션.
- server.error.whiteLabel.enabled=true : 오류 처리 화면을 못 찾을 시, 스프링 whiteLabel 오류 페이지 적용.
- server.error.path=/error : 오류 페이지 경로, 스프링이 자동 등록하는 서블릿 글로벌 오류 페이지 경로와 BasicErrorController 경로 함께 사용


### 설정.
- never : 사용하지 않음.
- always : 항상 사용.
- on_param : 파라미터가 있을 때 사용.


### 실무.
- 실무에서는 이것들을 노출하면 안된다, 오류는 서버에 로그로 남겨서 로그로 확인해야 한다.


### 확장 포인트.
- 에러 공통 처리 컨트롤러와 기능을 변경하고 싶으면 ErrorController 인터페이스 또는 BasicErrorController를 상속 받아 구현.

------------------------------------------------------------------------------------------------------------------------------------

### 정리.

### 오류 처리.
1. 페이지를 보여줄 때 오류 처리.
2. API에서 오류 처리.














