
# 쓰레드 로컬 ThreadLocal

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## 필드 동기화 - 개발

### 개요
- 로그 추적기는 트랜잭션 ID와 Level을 동기화하는 문제가 있었다
- TraceId를 파라미터로 넘기지 않고 넘기는 방법에 대해 생각해보자

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## 필드 동기화 - 적용

### 문제
- FieldLogTrace 클래스를 싱글톤으로 처리하기 때문에 동시에 요청이 발생하면 TraceId를 같이 사용하게 되는 오류가 발생한다

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## 동시성 문제 - 예제 코드

### 동시성 문제
- 여러 쓰레드가 같은 인스턴스의 필드에 접근해야 하기 땜누에 트래픽이 적은 상황에서는 확률상 잘 나타나지 않고, 점점 많아질수록 자주 발생한다
- 특히 스프링빈처럼 싱글톤 객체의 필드를 변경하며 사용할 때 이러한 동시성 문제를 조심해야 한다


### 참고
- 동시성 문제는 지역 변수에서는 발생하지 않는다
- 동시성 문제는 값을 읽기만 하면 발생하지 않는다 어디선가 값을 변경하기 때문에 발생한다

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## ThreadLocal 소개

### ThreadLocal
- 각 쓰레드마다 별도의 내부 저장소를 만든다 (해당 쓰레드만 접근할 수 있는 특별한 저장소를 만든다)
- 자바는 java.lang.ThreadLocal 클래스 제공

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## ThreadLocal 예제 코드

### ThreadLocal 사용 방법
    ThreadLocal<T> value = new ThreadLocal<>();
    
    value.set("값")  // 쓰레드로컬에 값 담기
    value.get()      // 쓰레드로컬에 담긴 값 얻기

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## ThreadLocal

### ThreadLocal.remove()
- 쓰레드 로컬을 모두 사용하고 나면 꼭 ThreadLocal.remove()를 호출해서 쓰레드 로컬에 저장된 값을 제거해줘야 한다

-----------------------------------------------------------------------------------------------------------------------------------------------

> ## 쓰레드 로컬 - 주의사항

### 개요
- 쓰레드 로칼의 값을 사용 후 제거하지 않고 그냥 두면 WAS처럼 쓰레드 풀을 사용하는 경우에 심각한 문제가 발생할 수 있다


### 문제점
- 쓰레드 풀을 이용하면 Thread 연결을 끊지 않기 때문에 ThreadLocal.remove()를 하지 않으면 ThreadLocal의 데이터를 다른 사용자가 볼 수 있는 상황이 발생할 수 있다






















