
 # 빈 후처리기

-------------------------------------------------------------------------------------------------------------------------------

> ## 빈 후처리기 - 소개

### 빈 후처리기
- 스프링이 빈 저장소에 등록할 목적으로 생성한 객체를 빈 저장소에 등록하기 직전에 조작하고 싶다면 빈 후처리기를 사용하면 된다
- BeanPostProcessor 인터페이스를 통해 빈을 생성한 후에 무언가를 처리하는 용도로 사용한다


### 빈 후처리기 기능
- 객체를 조작할 수도 있고, 완전히 다른 객체로 바꿔치기 하는 것도 가능하다


### 빈 후처리기 - 빈 등록 과정 
1. 생성 : 스프링 빈 대상이 되는 객체를 생성한다 (@Bean, 컴포넌트 스캔)
2. 전달 : 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달한다
3. 후 처리 작업 : 빈 후처리기는 전달된 스프링 빈 객체를 조작하거나 다른 객체로 바꿔치기 할 수 있다
4. 등록 : 빈 후처리기는 빈을 반환한다. 전달 된 빈을 그대로 반환하면 해당 빈이 등록, 바꿔치기 하면 다른 객체가 빈 저장소에 등록된다

-------------------------------------------------------------------------------------------------------------------------------

> ## 빈 후처리기 - 예제 코드

### 정리
- 빈 후처리기는 빈을 조작하고 변경할 수 있는 후킹 포인트다
- 일반적으로 스프링 컨테이너가 등록하는, 특히 컴포넌트 스캔의 대상이 되는 빈들은 중간에 조작할 방법이 없는데, 빈 후처리기를 사용하면 모든 빈을 조작할 수 있다


### @PostConstruct의 비밀
- @PostConstruct는 스프링 빈 생성 이후에 빈을 초기화하는 역할을 한다
- 빈의 초기화라는 것은 단순히 @PostConstruct 어노테이션이 붙은 초기화 메서드를 한번 호출만 하면 된다
- 스프링은 CommonAnnotationBeanPostProcessor 라는 빈 후처리기를 자동으로 등록하는데, 여기에서 @PostConstruct 어노테이션이 붙은 메서드를 호출한다

-------------------------------------------------------------------------------------------------------------------------------

> ## 빈 후처리기 - 적용

### 빈 후처리기 적용
- 빈 후처리기를 사용해서 실제 객체 댓니 프록시를 스프링 빈으로 등록해보자


### 프록시 적용 대상 여부 체크
- 스프링 부트가 기본으로 제공하는 빈 중에는 프록시 객체를 만들 수 없는 빈들도 있다 (모든 객체를 프록시로 만들 경우 오류가 발생)

-------------------------------------------------------------------------------------------------------------------------------

> ## 빈 후처리기 - 정리

### 문제1 - 너무 많은 설정
- 프록시를 직접 스프링 빈으로 등록하면 프록시 관련 설정이 지나치게 많다는 문제가 있다


### 문제2 - 컴포넌트 스캔
- 컴포넌트 스캔을 사용하는 경우 빈 후처리기 이전 방법으로는 프록시 적용이 불가능했다


### 문제 해결
- 빈 후처리기 덕분에 프록시를 생성하는 부분을 하나로 집중할 수 있다
- 덕분에 어플리케이션에 수 많은 스프링 빈이 추가되어도 프록시와 관련된 코드는 전혀 변경하지 않아도 된다


### 스프링
- 스프링은 프록시를 생성하기 위한 빈 후처리기를 이미 만들어서 제공한다


### 중요
- 포인트컷을 사용하면 프록시 적용 대상 여부를 정밀하게 설정할 수 있다


### 포인트 컷 기능
1. 프록시 적용 대상 여부를 체크해서 꼭 필요한 곳에만 프록시를 적용한다 (빈 후처리기 - 자동 프록시 생성)
2. 프록시의 어떤 메서드가 호출 되었을 때 어드바이스를 적용할 지 판단한다 (프록시 내부)

-------------------------------------------------------------------------------------------------------------------------------

> ## 스프링이 제공하는 빈 후처리기 1

### 설정
    implementation 'org.springframework.boot:spring-boot-starter-aop'


### 자동 프록시 생성기 - AutoProxyCreator
- 자동 프록시 생성기 AnnotationAwareAspectJAutoProxyCreator 라는 빈 후처리기가 스프링 빈에 자동으로 등록된다
- 이름 그대로 자동으로 프록시를 생성해주는 빈 후처리기이다
- 이 빈 후처리기는 스프링 빈으로 등록된 Advisor들을 찾아서 프록시가 필요한 곳에 자동으로 프록시를 적용해준다


### 자동 프록시 생성기의 작동 과정
1. 생성 : 스프링이 스프링 밴 대상이 되는 객체를 생성한다 (@Bean, 컴포넌트 스캔)
2. 전달 : 생성된 객체를 빈 저장소에 등록하기 직전에 빈 후처리기에 전달한다
3. 모든 Advisor 빈 조회 : 자동 프록시 생성기(빈 후처리기)는 스프링 컨테이너에서 모든 Advisor를 조회한다
4. 프록시 적용 대상 체크 : 앞서 조회한 Advisor에 포함되어 있는 포인트 컷을 사용해서 해당 객체가 프록시를 적용할 대상인지 아닌지 판단한다
5. 프록시 생성 : 프록시 적용 대상이면 프록시를 생성하고 반환해서 프록시를 스프링 빈으로 등록한다
6. 빈 등록 : 반환된 객체는 스프링 빈으로 등록된다


### 포인트 컷 기능 2가지
1. 프록시 적용 여부 판단 - 생성 단계
   - 자동 프록시 생성기는 포인트 컷을 사용해서 해당 빈이 프록시를 생성할 필요가 있는지 체크
   - 조건에 맞는 것이 하나라도 있으면 프록시를 생성한다
2. 어드바이스 적용 여부 판단 - 사용 단계
   - 프록시가 호출되었을 때 부가 기능인 어드바이스를 적용할지 말지 포인트 컷을 보고 판단한다

-------------------------------------------------------------------------------------------------------------------------------

> ## 스프링이 제공하는 빈 후처리기 2

### AspectJExpressionPointcut
    execution(* hello.proxy.app..*(..))
- AspectJ라는 AOP에 특화된 포인트컷 표현식을 적용할 수 있다
- "*" : 모든 반환 타입
- hello.proxy.app.. : 해당 패키지와 그 하위 패키지
- "*(..)" : * 모든 메서드 이름, (..) 모든 파라미터

-------------------------------------------------------------------------------------------------------------------------------

> ## 하나의 프록시, 여러 Advisor 적용

### 프록시 자동 생성기 상황별 정리
1. advisor1의 포인트컷만 만족
   - 프록시 1개 생성, 프록시에 advisor1만 포함
2. advisor1, advisor2 포인트컷을 모두 만족
   - 프록시 1개 생성, 프록시에 advisor1, advisor2 모두 포함
3. advisor1, advisor2의 포인트컷을 모두 만족하지 않음
   - 프록시가 생성되지 않음


### @Order
- Advisor가 여러 개인 경우 순서를 지정해서 우선순위를 설정할 수 있다
























