
# 파일 업로드.

------------------------------------------------------------------------------------------------------------------------------------

> ## 파일 업로드 소개

### HTML 폼 전송 방식
- application/x-www-form-urlencoded.
  - HTML 폼 데이터를 서버로 전송하는 가장 기본적인 방법.
  - Form 태그에 "enctype" 옵션이 없으면 웹 브라우저는 요청 HTTP 메시지의 헤더에 다음 내용을 추가한다.
  - 문자를 전송하는 이 방식으로 파일을 전송하기 어렵다.
- multipart/form-data.
  - 문자와 바이너리를 동시에 전송해야 하는 상황에 사용한다.
  - 이 방식을 사용하려면 Form 태그에 별도의 <form ... enctype="multipart/form-data">를 설정해야 한다.


### multipart/form-data.
- 다른 종류의 여러 파일과 폼의 내용을 함께 전송할 수 있다.
- "Content-Disposition"이라는 항목별 헤더가 추가되어 각각의 전송 항목이 구분되고, 여기에 부가 정보가 있다.
- 파일의 경우 파일 이름과 Content-Type이 추가되고 바이너리 데이터가 전송된다.


## Part.
- "multipart/form-data"는 매우 복잡하고 각각의 부분(Part)로 나누어져 있다.

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿과 파일 업로드1.

### 멀티 파트 업로드 사이즈 제한. 
    // 업로드 사이즈 제한
    spring.servlet.multipart.max-file-size=1MB
    spring.servlet-multipart.max-request-size=10MB
- max-file-size : 파일 하나의 최대 사이즈.
- max-request-size : 요청 총 파일의 합. (기본 10MB)


### 멀티 파트 처리 끄기.
    spring.servlet.multipart.enabled=false (기본값 true)
- false : 서블릿 컨테이너는 멀티파트와 관련된 처리를 하지 않는다.
- request.getParameter(...), request.getParts() 등의 결과가 비어있다.
- 로그를 보면 "HttpServletRequest" 객체가 "RequestFacade -> StandardMultipartHttpServletRequest"로 변한 것을 확인할 수 있다.


### 참고.
- enabled 옵션을 "true"하면 스프링의 "DispatcherServlet"에서 "MultipartResolver"를 실행한다.
- "MultipartResolver"는 요청이 멀티파트인 경우 서블릿 컨테이너가 전달하는 "HttpServletRequest"를 "MultipartHttpServletRequest"로 변환한다.
- 스프링이 제공하는 기본 "MultipartResolver"는 "StandardMultipartHttpServletResolver"를 반환한다.
- 그러나 "MultipartHttpServletRequest"보다 더 편리한 "MultipartFile"이라는 것을 사용한다.

------------------------------------------------------------------------------------------------------------------------------------

> ## 서블릿과 파일 업로드2.

### properties 값 주입.
    @Value("${file.dir}")
    private String fileDir;


### Part 주요 메서드.
- getSubmittedFileName() : 클라이언트가 전달한 파일명
- getInputStream() : "Part"의 전송 데이터를 읽을 수 있다.
- write(...) : "Part"를 통해 전송된 데이터를 저장할 수 있다.


### 참고.
- 큰 용량의 파일을 업로드를 테스트할 때는 로그가 너무 많이 남아서 로깅 옵션을 끄는 것이 좋다.

------------------------------------------------------------------------------------------------------------------------------------

> ## 스프링과 파일 업로드.

### MultipartFile 주요 메서드.
- file.getOriginalFileName() : 업로드 파일 명.
- file.transferTo(...) : 파일 저장.

------------------------------------------------------------------------------------------------------------------------------------

> ## 예제로 구현하는 파일 업로드, 다운로드.

### 파일명 인코딩.
    UriUtils.encode("파일이름", StandardCharsets.UTF_8)
- 한글, 특수문자 인코딩.


### 파일 다운로드 하기.

    UrlResource resouce = new UrlResouce("file:/파일경로/파일이름");
    String contentDisposition = "attachment; filename="파일이름"; 

    ResponseEntity.ok()
              .header(HttpHeaders.CONTENT_DISPOSITION, contentDisposition)
              .body(resouce);


