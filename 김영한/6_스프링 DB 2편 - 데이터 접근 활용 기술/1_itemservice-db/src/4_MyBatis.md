
 # MyBatis

---------------------------------------------------------------------------------------------------------------------------------

> ## MyBatis 소개

### MtBatis
- MyBatis는 SQL을 XML에 작성하기 때문에 라인이 길어져도 문자 더하기에 대한 불편함이 없다


### 동적 쿼리
- MyBatis는 동적 쿼리를 매우 편리하게 작성할 수 있는 다양한 기능들을 제공해준다


### 설정의 장단점
- JdbcTemplate은 내장된 기능이고, 별도의 설정없이 사용할 수 있다는 장점이 있다.
- 반면에 MyBatis는 약간의 설정이 필요하다


### 정리
- 프로젝트에 동적 쿼리와 복자한 쿼리가 많다면 MyBatis를 사용하고, 단순한 쿼리들이 많으면 JdbcTemplate을 선택해서 사용하면 된다

---------------------------------------------------------------------------------------------------------------------------------

> ## MyBatis 설정

### 주의
- main, test 모든 application.properties에 설정을 해줘야 한다


### Mybatis 설정
- mybatis.type-aliases-package
  - 마이바티스에서 타입 정보를 사용할 떄는 패키지 이름을 적어주어야 하는데, 위와 같은 설정을 명시하면 패키지 이름을 생략할 수 있다
  - 지정한 패키지와 그 하위 패키지가 자동으로 인식된다
  - 여러 위치를 지정하려면 ',', ';'로 구분하면 된다
- mybatis.configuration.map-underscore-to-camel-case
  - BeanPropertyRowMapper에서 처럼 언더바를 카멜로 자동 변경해주는 기능을 활성화 한다
- logging.level.hello.itemservice.repository.mybatis=trace
  - MyBatis에서 실행되는 쿼리 로그를 확인할 수 있다

---------------------------------------------------------------------------------------------------------------------------------

> ## 기본

### Mapper 인터페이스
- @Mapper를 붙이는 인터페이스를 만들어줘야 한다
- 이 인터페이스의 메서드를 호출하면 마이바티스 매핑 XML을 호출해준다


### XML 파일 경로 수정하기
    mybatis.mapper-location=classpath:mapper/**/*.xml
- XML 파일을 원하는 위치에 두고 싶으면 application.properties에 설정하면 된다
- 이렇게 하면 resources/mapper를 포함한 그 하위 폴더에 있는 XML을 XML 매핑 파일로 인식한다
- 이 경우 파일 이름은 자유롭게 설정해도 된다


### XML 특수문자
    < == &lt;
    > == &gt;
    & == &amp;
    <![CDATA[<]]>

---------------------------------------------------------------------------------------------------------------------------------

> ## 분석

### 개요
- 매퍼 인터페이스의 구현ㄴ체가 없는데 어떻게 동작한 것일까?


### MyBatis 스프링 연동 모듈
1. 어플리케이션 로딩 시점에 MyBatis 스프링 연동 모듈은 @Mapper가 붙어있는 인터페이스를 조사한다
2. 해당 인터페이스가 발견되면 동적 프록시 기술을 사용해서 ItemMapper 인터페이스의 구현체를 만든다
3. 생성된 구현체를 스프링 빈으로 등록한다


### 매퍼 구현체
- 매퍼 구현체는 예외 변환까지 처리해준다
- MyBatis에서 발생한 예외를 스프링 예외 추상화인 "DataAccessException"에 맞게 변환해서 반환해준다


### 정리
- 매퍼 구현체 덕분에 마이바티스를 스프링에 편리하게 통합해서 사용할 수 있다
- 매퍼 구현체를 사용하면 스플이 에외 추상화도 함께 적용된다
- 데이터베이스 커넥션, 트랜잭션과 관련된 기능도 마이바티스와 함께 연동하고, 동기화해준다

---------------------------------------------------------------------------------------------------------------------------------

> ## 동적 쿼리

### 동적 SQL
- 마이바티스가 제공하는 최고의 기능이자 마이바티스를 사용하는 이유는 바로 동적 SQL 기능 때문이다


### if
    <if test="조건">
      AND title LIKE '%' | #{title} | '%'
    </if>
- 해당 조건에 따라 값을 추가할지 말지 판단한다
- 내부의 문법은 OGNL을 사용한다, 자세한 내용은 OGNL을 검색해보자


### where
    <where>
      ...
    </where>
- <where>는 문장이 없으면 where를 추가하지 않는다
- 만약 and가 먼저 시작된다면 and를 지운다


### trim
    <trim prefix="WHERE" prefixOverrides="AND |OR ">
      ...
    </trim>
- 이렇게 정의하면 <where>와 같은 기능을 수행한다


### foreach
    <foreach item="item" index="index" collection="list" ...>
      #{item}
    </foreach>
- 컬렉션을 반복 처리할 때 사용한다.
- 파라미터로 List를 전달하면 된다

---------------------------------------------------------------------------------------------------------------------------------

> ## 기타 기능

### 어노테이션으로 SQL 작성
    // mapper 인터페이스
    @Select("select id, ... from item ...")
    List<Item> findAll(...);
- XML이 아닌 인터페이스에 어노테이션을 통해 쿼리를 작성할 수 있다
- 거의 사용하지 않음
  - 동적 쿼리를 사용할 수 없음


### 문자열 대체 String Substitution
    ${id}
- 파라미터 바인딩이 아니라 문자 그대로를 처리하고 싶은 경우에 사용한다
- 주의사항 SQL 인젝션 공격을 당할 수 있다


### 재사용 가능한 SQL 조각
    <sql id="userColums">사용할 문장</sql>
    <include id="userColums"/>
- XML에서 중복 되는 코드를 미리 정의해놓고 여러 쿼리에서 사용할 수 있다


### Result Maps
    <resultMap id="userResultMap" type="User">
      <id property="id" column="user_id"/>
      ...
    </resultMap>

    <select ... resultMape="userResultMap">
      ...
    </select>
- 별칭을 사용하지 않고 resultMap을 만들어서 매핑된 결과를 얻을 수 있다


### 복잡한 결과매핑
- 복잡한 결과에 객체 연관관계를 고려해서 데이터를 조회하는 것이 가능하다
- <association>, <collection> 등을 사용한다
- 이 부분은 성능과 실효성 측면에서 많은 고민이 필요하다




























