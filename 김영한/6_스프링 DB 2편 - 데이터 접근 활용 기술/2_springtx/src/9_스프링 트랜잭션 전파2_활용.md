
# 스프링 트랜잭션 전파1_활용

--------------------------------------------------------------------------------------------------------------------------------

> ## 커밋, 롤백

### 레포지토리 커밋
- 레포지토리 각각 트랜잭션을 가지고 있는 경우 어떻게 동작하는지 알아보자


### REQUIRED
- 트랜잭션의 전파 속성의 기본값


### 오류 발생
1. LogRepository는 트랜잭션 C와 관련된 con2를 사용한다
2. "로그예외" 라는 이름을 전닮해서 LogRepository에 런타임 예외가 발생한다
3. LogRepository는 해당 예외를 밖으로 던진다, 이 경우 트랜잭션 AOP가 예외를 받게된다
4. 런타임 예외가 발생해서 트랝개션 AOP는 트랜잭션 매니저에 롤백을 호출한다
5. 트랜잭션 매니저는 신규 트랜잭션이므로 물리 롤백을 호출한다

--------------------------------------------------------------------------------------------------------------------------------

> ## 단일 트랜잭션

### 개요
- 회원 리포지토리와 로그 리포지토리를 하나의 트랜잭션으로 묶는 방법은 회원 서비스에만 트랜잭션을 묶는 것이다


### 트랜잭션 전파의 필요성
- 서비스, 리포지토리를 여러 클라이언트가 다양하게 사용하는 경우 트랜잭션을 설정하기 까다롭다 
- 이런 문제를 해결하기 위해 트랜잰션 전파가 필요하다

--------------------------------------------------------------------------------------------------------------------------------

> ## 전파 커밋

### REQUIRED
- 트랜잭션 기본 옵션
- 트랜잭션이 없으면 트랜잭션을 생성하고, 있으면 기존 트랜잭션에 참여한다


### 물리 트랜잭션
- 실제 트랜잭션
- 내부 논리 트랜잭션이 모두 커밋되어야 물리 트랜잭션이 커밋될 수 있다


### 논리 트랜잭션
- 물리 트랜잭션 안에 존재하는 논리적인 트랜잭션

--------------------------------------------------------------------------------------------------------------------------------

> ## 복구 REQUIRED

### 개요
- 회원 가입을 시도한 로그를 남기는데 실패하더라도 회원 가입은 유지되어야 한다


### UnexpectedRollbackException
- rollbackOnly가 체크되고, 논리 트랜잭션에서 하나라도 롤백되는 경우 발생하는 Exception

--------------------------------------------------------------------------------------------------------------------------------

> ## REQUIRES_NEW

### 개요
- 위에 문제를 해결하기 위해 REQUIRES_NEW를 활용하는 방법


### REQUIRES_NEW
- 항상 신규 트랜잭션을 생성한다
- MemberService, MemberRepository는 하나의 물리트랜잭션으로 묶인다 (2개의 논리 트랜잭션)
- LogRepository는 새로운 물리 트랜잭션을 만든다


### 주의
- "REQUIRES_NEW"를 사용하면 하나의 HTTP 요청에 동시에 2개의 데이터베이스 커넥션을 사용한다 (성능 주의)
- "REQUIRES_NEW"를 사용하지 않고 문제를 해결할 수 있는 단순한 방법이 있다면, 그 방법을 선택하는 것이 더 좋다 (Facade 구조)











