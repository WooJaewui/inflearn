
# 스프링 AOP 개념

-------------------------------------------------------------------------------------------------------------------------------

> ## AOP 소개 - 핵심 기능과 부가 기능

### 핵심 기능과 부가 기능
- 어플리케이션 로직은 크게 핵심 기능과 부가 기능으로 나눌 수 있다
- 핵심 기능
  - 해당 객체가 제공하는 고유의 기능
  - 예) OrderService의 핵심 기능은 주문 로직이다
- 부가 기능
  - 핵심 기능을 보조하기 위해 제공되는 기능
  - 예) 로그 추적 기능
  - 이러한 부가 기능은 횡단 관심사(cross-cutting concerns)가 된다


### 부가 기능 적용 문제
- 부가 기능을 적용할 때 아주 많은 반복이 필요하다
- 부가 기능이 여러 곳에 퍼져서 중복 코드를 만들어낸다
- 부가 기능을 변경할 때 중복 때문에 많은 수정이 필요하다
- 부가 기능의 적용 대상을 변경할 때 많은 수정이 필요하다

-------------------------------------------------------------------------------------------------------------------------------

> ## AOP 소개 - 애스펙트

### 에스펙트 aspect
- 부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합해서 하나의 모듈로 만들었다


### 참고
- AOP는 OOP를 대체하기 위한 것이 아니라 횡단 관심사를 깔끔하게 처리하기 어려운 OOP의 부족한 부분을 보조하는 목적으로 개발되었다


### AspectJ 프레임워크
- AOP의 대표적인 구현으로 AspectJ 프레임워크가 있다
- 스프링도 AOP를 지원하지만 대부분 AspectJ 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공한다


### AspectJ 프레임워크 기능
- 자바 프로그래밍 언어에 대한 완벽한 관점 지향 확장
- 횡단 관심사의 깔끔한 모듈화
  - 오류 검사 및 처리
  - 동기화
  - 성능 최적화(캐싱)
  - 모니터링 및 로깅

-------------------------------------------------------------------------------------------------------------------------------

> ## AOP 적용 방식

### AOP 적용 방식
1. 컴파일 시점
2. 클래스 로딩 시점
3. 런타임 시점(프록시)


### 컴파일 시점 (AspectJ 프레임워크 사용)
- AspectJ가 제공하는 특별한 컴파일러를 사용해야 한다
- 부가 기능 코드가 핵심 기능이 있는 컴파일된 코드 주변에 실제로 붙어 버린다고 생각하면 된다
- 이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다
- 단점
  - 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러도 필요하고 복잡하다


### 클래스 로딩 시점
- .class 파일을 JVM 내부의 클래스 로더에 보관하는 시점에 .class 파일을 조작한 다음 JVM에 올릴 수 있다
- Java Instrumentation을 검색해보자 (많은 모니터링 툴들이 이 방식을 사용한다)
- 이 시점에 에스펙트를 적용하는 것을 로드 타임 위빙이라고 한다
- 단점
  - java -javaagent를 통해 클래스 로더 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다


### 런타임 시점
- 자바의 메인 메서드가 이미 실행된 다음이다. 따라서 자바 언어가 제공하는 범위 안에서 부가 기능을 적용해야 한다
- 스프링과 같은 컨테이너의 도움을 받고 프록시와 DI, 빈 포스트 프로세서같은 개념들을 총 동원해야 한다
- 단점
  - 프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다 (final class, final method, 생성자 등에 제약이 있다)


### AOP 적용 위치 (조인 포인트)
- 컴파일 시점, 클래스 로딩 시점
  - AOP를 적용할 수 있는 지점
  - 생성자
  - 필드 값 접근
  - static 메서드 접근
  - 메서드 실행
- 런 타임(프록시 방식)
  - 프록시 메서드는 오버라이딩 개념으로 동작한다. 따라서 static 메서드, 필드 값 접근에는 프록시 개념이 적용될 수 없다
  - 프록시를 사용하는 스프링 AOP의 조인 포인트는 메서드 실행으로 제한된다
  - 스프링 AOP를 사용하는 경우 스프링 컨테이너가 관리하는 빈만 AOP를 적용할 수 있다


### 참고
- 스프링은 AspectJ의 문법을 차용하고 프록시 방식의 AOP를 적용한다. AspectJ를 직접 사용하는 것이 아니다


### 중요
- 스프링이 제공하는 AOP는 프록시를 사용한다. 따라서 프록시를 통해 메서드를 실행하는 시점에만 AOP가 적용된다
- AspectJ는 기능이 많지만, 공부할 내용도 많고, 설정도 복잡하다
- 그래서 실무에서는 스프링이 제공하는 AOP 기능만 사용해도 대부분의 문제를 해결할 수 있다

-------------------------------------------------------------------------------------------------------------------------------

> ## AOP 용어 정리

### 조인 포인트 Join Point
- 어드바이스가 적용될 수 있는 위치, 메서드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점
- 조인 포인트는 추상적인 개념이다. AOP를 적용할 수 있는 모든 지점이라 생각하면 된다
- 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메서드 실행 지점으로 제한된다


### 포인트 컷 Pointcut
- 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
- 주로 AspectJ 표현식을 사용해서 지정
- 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트 컷으로 선별 가능


### 타겟 Target
- 어드바이스를 받는 객체, 포인트 컷으로 결정


### 어드바이스 Advice
- 부가 기능
- 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
- Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음


### 애스펙트 Aspect
- 어드바이스 + 포인트 컷을 모듈화한 것
- @Aspect를 생각하면 됨
- 여러 어드바이스와 포인트 컷이 함께 존재


### 어드바이저 Advisor
- 하나의 어드바이스와 하나의 포인트 컷으로 구성
- 스프링 AOP에서만 사용되는 특별한 용어


### 위빙 Weaving
- 포인트 컷으로 결한 타겟의 조인 포인트에 어드바이스를 적용하는 것
- 위빙을 통해 갯미 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음
- AOP 적용을 위해 애스펙트를 객체에 연결한 상태
  - 컴파일 타임
  - 로드 타임
  - 런타임, 스프링 AOP는 런타임, 프록시 방식


### AOP 프록시
- AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시이다



































