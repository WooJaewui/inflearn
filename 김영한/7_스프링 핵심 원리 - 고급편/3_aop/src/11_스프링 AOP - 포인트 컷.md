
# 스프링 AOP - 포인트 컷

-----------------------------------------------------------------------------------------------------------------------------------

> ## 포인트 컷 지시자

### 포인트 컷 지시자의 종류
- execution : 메서드 실행 조인 포인트를 매칭한다, 스프링 AOP에서 가장 많이 사용하고, 기능도 복잡하다
- within : 특정 타입 내의 조인 포인트를 매칭한다
- args : 인자가 주어진 타입의 인스턴스인 조인 포인트
- this : 스프링 빈 객체(스프링 AOP 프록시)를 대상으로 하는 조인 포인트
- target : Target 객체(스프링 AOP 프록시가 가르키는 실제 대상)를 대상으로 하는 조인 포인트
- @target : 실행 객체의 클래스에 주어진 타입의 어노테이션이 있는 조인 포인트
- @within : 주어진 어노테이션이 있는 타입 내 조인 포인트
- @annotation : 메서드가 주어진 어노테이션을 가지고 있는 조인 포인트를 매칭
- @args : 전달된 실제 인수의 런타임 타입이 주어진 타입의 어노테이션을 갖는 조인 포인트
- bean : 스프링 전용 포인트컷 지시자, 빈의 이름으로 포인트컷을 지정한다


### 참고
- execution을 중점적으로 이해하자 (가장 많이 사용)

-----------------------------------------------------------------------------------------------------------------------------------

> ## execution - 1

### execution 문법
    // execution(접근제어자? 반환타입 선언타입? 메서드이름(파라미터) 예외?)
    execution(public java.lang.String hello.aopmember.MemberServiceImpl.hello(java.lang.String))
- 접근제어자? : public
- 반환타입 : String
- 선언타입? : hello.aop.member.MemberSerivceImpl
- 메서드이름 : hello
- 파라미터 : (String)
- 예외? : 생략


### 가장 많은 범위 포인트 컷
    "execution(* * (..))"
- 접근제어자? : 생략
- 반환타입 : *
- 선언타입? : 생략
- 메서드 이름 : *
- 파라미터 : (..)
- 예외? : 생략


### 패키지 설정
    . : 정확하게 해당 위치의 패키지
    .. : 해당 위치의 패키지와 그 하위 패키지도 포함
- execution(* hello.aop.*.*(..)) : hello.aop에 있는 모든 패키지
- execution(* hello.aop..*.*(..)) : hello.aop 하위에 모든 패키지

-----------------------------------------------------------------------------------------------------------------------------------

> ## execution - 2

### 타입 매칭
- 부모 타입을 execution에 선언하면 하위 타입들도 적용이 가능하다
- 부모 타입에 없는 메서드는 매칭에 포인트 컷 매칭에 실패한다


### 파라미터 매칭
- (String) : 정확하게 String 타입 파라미터
- () : 파라미터가 없다
- (*) : 정확히 하나의 파라미터, 단 모든 타입을 허용
- (*, *) : 정확히 두 개의 파라미터, 단 모든 타입을 허용
- (..) : 숫자와 무관하게 모든 파라미터, 모든 타입을 허용, 파라미터가 없어도 됨
- (String, ..) : String 타입으로 시작된 모든 파라미터 허용

-----------------------------------------------------------------------------------------------------------------------------------

> ## within

### within
- 특정 타입 내의 조인 포인트에 대한 매칭을 제한한다
- 해당 타입이 매칭되면 그 안의 메서드(조인 포인트)들이 자동으로 매칭된다


### 주의 사항
- within()은 정확하게 타입이 맞아야 한다 (execution처럼 부모 타입을 했을 경우, 자식 타입 매칭 불가능)
- 기능이 한정적이여서 잘 사용하지 않는다 (인터페이스를 선택할 수 없다)

-----------------------------------------------------------------------------------------------------------------------------------

> ## args

### args
- 인자가 주어진 타입의 인스턴스인 조인 포인트로 매칭
- args는 부모 타입을 허용한다 (execution 파라미터는 부모 타입을 허용하지 않는다)
- 실제 넘어온 파라미터 객체 인스턴스를 보고 판단한다


### 참고
- args 지시자는 단독으로 사용되기 보다는 뒤에서 설명할 파라미터 바인딩에서 주로 사용된다

-----------------------------------------------------------------------------------------------------------------------------------

> ## @target, @within

### 정의
- @target : 실행 객체의 클래스에 주어진 타입의 어노테이션이 있는 조인 포인트
- @within : 주어진 어노테이션이 있는 타입 내 조인 포인트


### @target
    @target(hello.aop.member.annotation.ClassAop)
- 인스턴스의 모든 메서드를 조인 포인트로 적용한다
- 부모 클래스의 메서드까지 어드바이스를 다 적용한다


### @within
    @within(hello.aop.member.annotation.ClassAop)
- 해당 타입 내에 있는 메서드만 조인 포인트로 적용한다
- 자기 자신의 클래스에 정의된 메서드에만 어드바이스를 적용한다


### 주의
- 위의 포인트컷 지시자는 단독으로 사용하면 안된다
- args, @args, @target은 실제 객체 인스턴스가 생성되고 실행될 때 어드바이스 적용 여부를 확인할 수 있다
- 위에 포인트컷 지시자들은 프록시가 있어야만 확인할 수 있기 때문에 모든 빈에 프록시를 적용하려고 시도한다 (빈에 final 클래스 등이 있으면 오류가 발생)

-----------------------------------------------------------------------------------------------------------------------------------

> ## @annotation, @args

### @annotation
    @annotation(hello.aop.member.annotation.MethodAop)
- 메서드가 주어진 어노테이션을 가지고 있는 조인 포인트를 매칭
- 메서드 어노테이션을 확인하는 방법


### @args
- 전달된 인수의 런타임 타입에 @Check 어노테이션이 있는 경우에 매칭된다
- 거의 사용되지 않는다

-----------------------------------------------------------------------------------------------------------------------------------

> ## bean

### bean
    bean(orderSerive) || bean(*Repository)
- 스프링 전용 포인트컷 지시자, 빈의 이름으로 지정한다

-----------------------------------------------------------------------------------------------------------------------------------

> ## 매개변수 전달

### 매개변수 전달
    @Before("allMember() && args(arg,..)")
    public void logArgs(String arg) {
        ...
    }
- 타입이 매칭되는 경우에만 사용할 수 있다


### 정리
- this : 프록시 객체를 전달 받는다
- target : 실제 대상 객체를 전달받는다 (실제 호출되는 메서드를 가진 클래스)
- @target, @within : 타입의 어노테이션을 전달 받는다
- @annotation : 메서드의 어노테이션을 전달 받는다

-----------------------------------------------------------------------------------------------------------------------------------

> ## this, target

### 정의
- this : 스프링 빈 객체(스프링 AOP 프록시)를 대상으로 하는 조인 포인트
- target : Target 객체(스프링 AOP 프록시가 가르키는 실제 대상)을 대상으로 하는 조인 포인트


### 참고
- "*" 같은 패턴을 사용할 수 없다
- 부모 타입을 허용한다


### 프록시 생성 방식에 따른 차이
- JDK 동적 프록시 : 인터페이스가 필수이고, 인터페이스를 구현한 프록시 객체를 생성한다
- CGLIB : 인터페이스가 있어도 구체 클래스를 상속 받아서 프록시 객체를 생성한다


### 정리
- 프록시를 대상으로 하는 this의 경우 구체 클래스를 지정하면 프록시 생성 전략에 따라 다른 결과가 나올 수 있다
- JDK 동적 프록시 - this(구체클래스) : 찾지 못함 (프록시가 인터페이스를 구현)  
- CGLIB - this(구체클래스) : 찾음 (프록시가 구체 클래스를 구현)


### 프록시 방식 설정
1. application.properties
   - CGLIB : spring.aop.proxy-target-class=true (부트 기본값) 
   - JDK 동적 프록시 : spring.aop.proxy-target-class=false
3. @SpringBootTest(properties=..)
   - CGLIB : spring.aop.proxy-target-class=true (부트 기본값)
   - JDK 동적 프록시 : spring.aop.proxy-target-class=false












