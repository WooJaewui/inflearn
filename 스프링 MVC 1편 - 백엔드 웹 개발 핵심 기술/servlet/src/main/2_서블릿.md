
# 서블릿.

-------------------------------------------------------------------------------------------------------------------------------

> ## Hello 서블릿.

### 참고.
- 서블릿은 톰캣같은 웹 어플리케이션 서버를 직접 설치하고, 그 위에 서블릿 코드를 클래스 파일로 빌드해서 올린 다음 톰캣 서버를 실행하면 된다.
- 스프링 부트는 톰캣 서버를 내장하고 있으므로, 톰캣 서버 설치 없이 편리하게 서블릿 코드를 실행할 수 있다.

### @ServletComponentScan.
- 어노테이션을 붙인 패키지 + 하위 패키지에 있는 서블릿을 자동 등록해준다.

### 서블릿 생성하기.
- @WebServlet() 어노테이션에 name과 urlPatterns를 등록해야 한다. (name/urlPatterns는 다른 서블릿과 중복되면 안된다)
- HttpServlet을 상속받고, service 메서드를 오버라이드 해야 한다.

### Request, Response 패키지.
- org.apache.catalina.connector.Request.
- org.apache.catalina.connector.Response

### response로 출력하기.
    response.setContentType("text/plain");
    response.setCharacterEncoding("utf-8");
    response.getWriter().write("내용");

### 로깅 하기.
- logging.level.org.apache.coyote.http11=debug (요청 정보를 로깅한다)
- 운영서버에 모든 요청 정보를 다 남기면 성능저하가 발생할 수 있다. (개발 단계에서만 적용)

### 서블릿 컨테이너 생성 순서.
- 스프링 부트 생성.
- 내장 톰캣 서버 실행.
- 서블릿 컨테이너에서 서블릿을 생성.

### 서블릿 컨테이너 동작 순서.
- 클라이언트가 url 요청을 함.
- 웹 브라우저는 클라이언트 url에 맞는 HTTP 메시지(Request)를 생성함.
- WAS는 HTTP 메시지(Request)를 기반으로 Request/Response를 생성하여 서블릿 컨테이너에 있는 서블릿을 호출.
- 호출된 서블릿은 작성해 놓은 코드를 실행하고 Response에 어떠한 수행을 작성하고 WAS에게 전달.
- WAS는 Response 객체 정보로 HTTP 메시지(Response) 생성 후 웹 브라우저에게 전달.

### 참고.
- HTTP 응답에서 Content-Length는 웹 애플리케이션 서버가 자동으로 생성해준다.
- 스프링 부트에서 webapp에 index.html 파일을 작성하면 url에 아무것도 입력안했을 때 index.html 페이지가 열린다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HttpServletRequest - 개요.

### HttpServletRequest 역할.
- HTTP 요청 메시지를 개발자가 직접 파싱해서 사용해도 되지만, 매우 불편할 것이다.
- 서블릿은 개발자가 HTTP 요청 메시지를 편리하게 사용할 수 있도록 개발자 대신에 HTTP 요청 메시지를 파싱한다.
- 그 결과를 HttpServletRequest 객체에 담아서 제공한다.
- HttpServletRequest를 사용하면 HTTP 요청 메시지를 편리하게 조회할 수 있다.

### HTTP 요청 메시지.
- Start Line.
  - HTTP 메서드.
  - URL.
  - 쿼리 스트링.
  - 스키마, 프로토콜.
- 헤더.
  - 헤더 조회.
- 바디.
  - form 파라미터 형식 조회.
  - message body 데이터 직접 조회.

### Request 임시 저장소 기능.
- 해당 HTTP 요청이 시작붙터 끝날때까지 유지되는 임시 저장소 기능.
  - 저장 : request.setAttribute(name,value)
  - 조회 : request.getAttribute(name)
- 세션 관리 기능.
  - 세션 조회 : request.getSession()

### 중요.
- HttpServletRequest, HttpServletResponse를 사용할 때 가장 중요한 점은 이 객체들이 Http 요청 메시지, Http 응답 메시지를 편리하게 사용.
- 따라서 이 기능에 대해서 깊이있는 이해를 하려면 HTTP 스펙이 제공하는 요청, 응답 메시지 자체를 이해해야 한다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HttpServletRequest - 기본 사용법.

### request 헤더 정보 읽어 오기.
    request.getHeaderNames().asIterator()
                .forEachRemaining(name -> System.out.println(name));

### request 쿠키 정보 읽어 오기.
    requset.getCookies().asIterator()
                .forEachRemaining(cookie -> System.out.println(name));

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 요청 데이터 - 개요.

### HTTP 요청 메시지를 통해 클라이언트에서 서버로 데이터를 전달하는 방법.
1. GET - 쿼리 파라미터.
   - /url?name=hello&...
   - 메시지 바디 없이, URL의 쿼리 파라미터에 데이터를 포함해서 전달.
   - 예) 검색, 필터, 페이징 등에 사용.
2. POST - HTML Form.
   - content-type:application/x-www-form-urlencoded
   - 메세지 바디에 쿼리 파라미터 형식으로 전달.
   - 예) 회원 가입, 상품 주문, HTML Form 사용.
3. HTTP message body에 데이터를 직접 담아서 요청.
   - HTTP API에서 주로 사용, JSON, XML, TEXT
   - 데이터 형식은 주로 JSON 사용.
   - POST, PUT, PATCH.

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 요청 데이터 - GET 쿼리 파라미터.

### 여러 파라미터를 조회하는 방법.
    // /url?username=hello&username=hello2

    String[] usernames = request.getParameterValues("username")
    for(String name = usernames) {
        System.out.println(name);
    }
- request.getParameterValues("파라미터이름");

### 복수 파라미터에서 단일 파라미터 조회.
- 중복 이름의 파라미터가 존재하는 경우, request.getParameter("파라미터이름")을 하면 첫번째 파라미터의 값이 반환된다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 요청 데이터 - POST HTML Form.

### 특징.
- content-type : 'application/x-www-form-urlencoded'
- 메시지 바디에 쿼리 파라미터 형식으로 데이터를 전달한다.
- 'application/x-www-form-urlencoded' 형식은 GET에서 살펴본 쿼리 파라미터 형식과 같다.

### 정리.
- request.getParameter()는 GET URL 쿼리 파라미터 형식도 지원하고, POST HTML Form 형식도 지원한다.

### 참고.
- content-type은 HTTP 메시지 바디의 데이터 형식을 지정한다.
- GET URL 쿼리 파라미터 형식으로 클라이언트에서 서버로 데이터를 전달할 때는 HTTP 메시지 바디를 사용하지 않기 때문에 content-type이 없다.
- POST HTML Form 형식으로 데이터를 전달하면 HTTP 메시지 바디에 해당 데이터를 포함해서 보내기 때문에 content-type을 꼭 지정해야 한다.
- 이렇게 Form으로 데이터를 전송하는 형식을 'application/x-www-form-urlencoded' 라고 한다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 요청 데이터 - API 메시지 바디 - 단순 텍스트.

### HTTP message body에 데이터를 직접 담아서 요청.
- HTTP API에서 주로 사용, JSON, XML, TEXT.
- 데이터 형식은 주로 JSON 사용.
- POST, PUT, PATCH.

### Request Body 내용 읽어오기.
    ServletInputStream input = request.getInputStream();
    String body = StreamUtils.copyToString(input, StandardCharsets.UTF_8);

    System.out.println(body);
- inputStream은 byte 코드를 반환한다.
- byte 코드를 우리가 읽을 수 있는 문자 String으로 보려면 문자표를 지정해주어야 한다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 요청 데이터 - API 메시지 바디 - JSON.

### ObjectMapper.
- jackson 라이브러리에 존재하는 JSON 형태로 매핑해주는 클래스.
- objectMapper.readValue(변환할데이터, 클래스이름.class);

### JSON 형태 예시.
    { "username" : "Hello", "age" : 10 }

### 참고.
- HTML Form 데이터도 메시지 바디를 통해 전송되므로 직접 읽을 수 있다.
- 하지만 파라미터 조회 기능을 제공하기 때문에 파라미터 조회 기능을 사용하면 된다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HttpServletResponse - 기본 사용법.

### HttpServletResponse 역할.
- HTTP 응답 메시지 생성.
  - HTTP 응답코드 지정. (200,400,404,... 등)
  - 헤더 생성.
  - 바디 생성.
- 편의 기능 제공.
  - Content-Type.
  - 쿠키.
  - Redirect.

### 응답 헤더 바꾸기.
    response.setStatus(200);
    response.setStatus(HttpServletResponse.SC_OK);

### 쿠키를 만드는 2가지 방법.
    // 1번 방법.
    response.setHeader("Set-Cookie", "쿠키이름=값; Max-Age=300");
    
    // 2번 방법.
    Cookie cookie = new Cookie("쿠키이름" , "값");
    response.addCookie(cookie);

### Response Body를 보내는 방법.
    response.getWriter().write("내용");
    response.getWriter().println("내용");

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 응답 데이터 - 단순 텍스트, HTML.

### 단순 텍스트 응답.
    writer.println("ok");
- 앞에서 살펴봄.

### HTML 응답.
    response.setContentType("text/html;charset=utf-8");
    writer.println("<html>");
    writer.println("<body>");
    writer.println("<div>안녕?</div>");
    writer.println("</body>");
    writer.println("</html>"):
- http 응답으로 HTML을 반환할 때는 content-type을 text/html로 지정해야 한다.

-------------------------------------------------------------------------------------------------------------------------------

> ## HTTP 응답 데이터 - API JSON.

### JSON 형태로 데이터 변환하기.
    UserVo vo = new UserVo();
    ObjectMapper objectMapper = new ObjectMapper();
    objectMapper.writeValueAsString(vo);

### JSON 형태로 출력하기.
- HTTP 응답으로 JSON을 반환할 때는 content-type을 application/json으로 지정해야 한다.
- application/json은 스펙상 utf-8 형식을 사용하도록 정의되어 있다. (charset=utf-8을 추가할 필요가 없다)

-------------------------------------------------------------------------------------------------------------------------------

> ## 정리.

### HTTP 요청 메시지 3가지 방법.
1. Get-파라미터.
   - 쿼리 스트링.
   - 메시지 바디 없이, URL의 쿼리 파라미터에 데이터를 포함해서 전달.
2. POST HTML Form.
   - content-type="application/x-www-form-urlencoded"
   - 메시지 바디에 쿼리 파라미터 형식으로 전달.
3. HTTP message body.
   - HTTP APi에서 주로 사용, JSON, XML, TEXT.
   - 데이터 형식은 주로 JSON 사용.
   - POST, PUT, PATCH

### 참고.
- form data Request는 PUT, PATCH method를 사용할 수 없다.

### 응답.
1. 텍스트 응답.
2. HTML 응답.
3. 데이터 응답.










