
# 스프링 시큐리티 주요 아키텍처 이해

------------------------------------------------------------------------------------------------------------------------

> ## 위임 필터 및 필터 빈 초기화 - DelegatingProxyChain, FilterChainProxy

### 영어 단어
- delegating : 위임하다


### DelegatingFilterProxy
- 서블릿 필터는 스프링에서 정의된 빈을 주입해서 사용할 수 없음 (Servlet Filter는 서블릿 컨테이너에 존재하기 때문)
- 특정한 이름을 가진 스프링 빈을 찾아 그 빈에게 요청을 위임
  - springSecurityFilterChain 이름으로 생성된 빈을 ApplicationContext에서 찾아 요청을 위임
  - 실제 보안처리를 하지 않음


### FilterChainProxy
1. springSecurityFilterChain의 이름으로 생성되는 필터 빈
2. DelegatingFilterProxy으로 부터 요청을 위임 받고 실제 보안 처리
3. 스프링 시큐리티 초기화 시 생성되는 필터들을 관리하고 제어
   - 스프링 시큐리티가 기본적으로 생성하는 필터
   - 설정 클래스에서 API 추가 시 생성되는 필터
4. 사용자의 요청을 필터 순서대로 호출하여 전달
5. 사용자정의 필터를 생성해서 기존의 필터 전.후로 추가 가능
    - 필터의 순서를 잘 정의
6. 마지막 필터까지 인증 및 인가 예외가 발생하지 않으면 보안 통과


### WebSecurityConfiguration
- Security 관련 configure 클래스
- FilterChainProxy를 "springSecurityFilterChain" 이름으로 빈을 등록

------------------------------------------------------------------------------------------------------------------------

> ## 필터 초기화와 다중 보안 설정

### WebSecurityConfigurerAdapter가 여러 개인 경우 (다중 보안 설정)
- 설정 클래스 별로 보안 기능이 각각 작동
- 설정 클래스 별로 RequestMatcher 설정
  - http.antMatcher("/admin/**")
- 설정 클래스 별로 필터가 생성
- FilterChainProxy가 각 필터들을 가지고 있음
- 요청에 따라 RequestMatcher와 매칭되는 필터가 작동하도록 함


### FilterChainProxy
    @Bean @Order(1)
    public SecurityFilterChain filterChain1(HttpSecurity http) throws Exception { ... }
    @Bean @Order(2)
    public SecurityFilterChain filterChain2(HttpSecurity http) throws Exception { ... }
- @Bean으로 등록한 SecurityFilterChain 개수만큼 Security 설정을 확인하고, match되는 FilterChain을 수행한다
- FilterChainProxy에 @Bean으로 등록한 모든 SecurityFilterChain의 List를 인스턴스 변수를 가지고 있음
- @Order(int) 순서에 따라 보안을 수행함

------------------------------------------------------------------------------------------------------------------------

> ## 인증 개념 이해 - Authentication

### 영어 단어
- principal : 주요한


### Authentication 인터페이스
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();     // Authentication 얻기
- 당신이 누구인지 증명하는 것
  - 사용자의 인증 정보를 저장하는 토큰 개념
  - 인증 시 id, password를 담고 인증 검증을 위해 전달되어 사용된다
  - 인증 후 최종 인증 결과 (user 객체, 권한 정보)를 담고 SecurityContext에 저장되어 전역적으로 참조가 가능하다
- 구조
  - principal : 사용자 아이디 혹은 User 객체를 저장
  - credentials : 사용자 비밀번호
  - authorities : 인증된 사용자의 권한 목록
  - details : 인증 부가 정보
  - authenticated : 인증 여부


### Authentication 인증 실행 순서
1. 클라이언트 username + password 로그인 요청
2. UsernamePasswordAuthenticationFilter에서 Authentication을 생성
   - principal : username
   - credentials : password
   - authenticated : false
3. AuthenticationManager를 통해 로그인 인증 체크
4. 인증 성공 후 Authentication 내용 변경
   - principal : UserDetails 클래스
   - credentials : --- (보안 상 비워둔다)
   - authenticated : true
5. Authentication을 SecurityContextHolder에 저장
   - 인증 객체를 전역적으로 사용 가능

------------------------------------------------------------------------------------------------------------------------

> ## 인증 저장소 - SecurityContextHolder, SecurityContext

### SecurityContext
- Authentication 객체가 저장되는 보관소로 필요 시 언제든지 Authentication 객체를 꺼내어 쓸 수 있도록 제공되는 클래스
- ThreadLocal에 저장되어 아무 곳에서나 참조가 가능하도록 설계함
- 인증이 완료되면 HttpSession에 저장되어 어플리케이션 전반에 걸쳐 전역적인 참조가 가능하다


### SecurityContextHolder
- SecurityContext 객체 저장 방식
  - MODE_THREADLOCAL : 쓰레드당 SecurityContext 객체를 할당 (기본값)
  - MODE_INHERITABLETHREADLOCAL : 메인 쓰레드와 자식 쓰레드에 관하여 동일한 SecurityContext를 유지
  - MODE_GLOBAL : 응용 프로그램에서 단 하나의 SecurityContext를 저장
- SecurityContextHolder.clearContext()
  - SecurityContext 기존 정보 초기화


### Authentication 전역으로 얻는 방법
    Authentication authentication = SecurityContextHolder.getConext().getAuthentication();


### 인증 실패 시
- SecurityContextHolder.clearContext()를 통해 SecurityContext 정보 초기화


### 인증 성공 시
- SecurityContextHolder 안에 SecurityContext 안에 Authentication을 저장하고, 인증 성공 시 SecurityContext가 HttpSesion에 저장
  - session key name : SPRING_SECURITY_CONTEXT


### SecurityContextHolder 전략 변경
    SecurityContextHolder.setStrategyName(SecurityContextHolder.MODE_INHERITABLETHREADLOCAL);

------------------------------------------------------------------------------------------------------------------------

> ## 인증 저장소 필터 - SecurityContextPersistenceFilter

### SecurityContextPersistenceFilter - deprecated
- SecurityContext 객체의 생성, 저장, 조회
- 익명 사용자
  - 새로운 SecurityContext 객체를 생성하여 SecurityContextHolder에 저장
  - AnonymousAuthenticationFilter에서 AnonymousAuthenticationToken 객체를 SecurityContext에 저장
- 인증 시
  - 새로운 SecurityContext 객체를 생성하여 SecurityContextHolder에 저장
  - 인증 성공 후 SecurityContext에 UsernamePasswordAuthenticationToken 객체를 SecurityContext에 저장
  - 인증이 최종 완료되면 Session에 SecurityContext를 저장
- 인증 후
  - Session에서 SecurityContext 꺼내서 SecurityContextHolder에서 저장
  - SecurityContext 안에 Authentication 객체가 존재하면 계속 인증을 유지
- 최종 응답 시 공통
  - SecurityContextHolder.clearContext()


### 최신 버전
- SecurityContextPersistenceFilter deprecated 되고, SecurityContextHolderFilter를 사용









